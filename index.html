<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Politik Simülasyon Oyunu - Test Arayüzü</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }
    .panel {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-top: 0;
      color: #333;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
      width: 100%;
    }
    button:hover {
      background-color: #45a049;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .log {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .log-item {
      margin: 5px 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .log-item.received {
      color: blue;
    }
    .log-item.sent {
      color: green;
    }
    .log-item.error {
      color: red;
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      background: #f0f0f0;
      width: 150px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }
    .card.selected {
      background-color: #e0f7e0;
      border-color: #4CAF50;
    }
    .game-status {
      margin-top: 15px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>Kontrol Paneli</h2>
      
      <div id="connection-panel">
        <h3>Bağlantı</h3>
        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
          <input type="text" id="server-url" placeholder="Ngrok URL" style="flex-grow: 1;">
          <button id="update-url-btn" style="width: auto; white-space: nowrap;">URL Güncelle</button>
        </div>
        <input type="text" id="player-name" placeholder="Oyuncu İsmi">
        <button id="connect-btn">Bağlan</button>
        <button id="disconnect-btn" disabled>Bağlantıyı Kes</button>
      </div>
      
      <div id="game-panel" style="display:none;">
        <h3>Oyun</h3>
        <button id="create-game-btn">Yeni Oyun Oluştur</button>
        <input type="text" id="game-id" placeholder="Oyun ID">
        <button id="join-game-btn">Oyuna Katıl</button>
        <button id="start-game-btn" disabled>Oyunu Başlat</button>
      </div>
      
      <div id="action-panel" style="display:none;">
        <h3>Aksiyonlar</h3>
        <div id="city-selection" style="display:none;">
          <h4>Şehir Seçimi</h4>
          <div id="city-cards" class="cards"></div>
          <button id="select-city-btn" disabled>Şehri Seç</button>
        </div>
        
        <div id="rally-organization" style="display:none;">
          <h4>Miting Düzenleme</h4>
          <div id="policy-cards" class="cards"></div>
          <button id="organize-rally-btn" disabled>Miting Düzenle</button>
        </div>
        
        <div id="election-bus" style="display:none;">
          <h4>Seçim Otobüsü</h4>
          <input type="text" id="chat-message" placeholder="Mesajınız...">
          <button id="send-message-btn">Gönder</button>
        </div>
        
        <div id="media-interaction" style="display:none;">
          <h4>Medya Etkileşimi</h4>
          <select id="media-action-type">
            <option value="statement">Basın Açıklaması</option>
            <option value="interview">Röportaj</option>
            <option value="advertisement">Reklam</option>
            <option value="pressConference">Basın Toplantısı</option>
            <option value="claim">İddia</option>
          </select>
          <input type="text" id="media-content" placeholder="Medya içeriği...">
          <input type="number" id="media-budget" placeholder="Bütçe" min="10" max="500" value="100">
          <button id="media-action-btn">Medya Aksiyonu</button>
        </div>
        
        <div id="player-controls">
          <button id="player-ready-btn" style="display:none;">Hazırım</button>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <h2>Oyun Ekranı</h2>
      
      <div class="game-status" id="game-status">
        Bağlantı bekleniyor...
      </div>
      
      <h3>Mesaj Geçmişi</h3>
      <div class="log" id="message-log"></div>
    </div>
  </div>

  <script>
    // Global değişkenler
    let ws;
    let connectionId;
    let playerId;
    let playerName;
    let currentGameId;
    let isGameOwner = false;
    let gameState = {
      turn: 0,
      phase: null,
      cards: {},
      selectedCards: []
    };
    
    // DOM elementleri
    const serverUrlInput = document.getElementById('server-url');
    const playerNameInput = document.getElementById('player-name');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const gameIdInput = document.getElementById('game-id');
    const createGameBtn = document.getElementById('create-game-btn');
    const joinGameBtn = document.getElementById('join-game-btn');
    const startGameBtn = document.getElementById('start-game-btn');
    const selectCityBtn = document.getElementById('select-city-btn');
    const organizeRallyBtn = document.getElementById('organize-rally-btn');
    const playerReadyBtn = document.getElementById('player-ready-btn');
    const gamePanel = document.getElementById('game-panel');
    const actionPanel = document.getElementById('action-panel');
    const citySelection = document.getElementById('city-selection');
    const rallyOrganization = document.getElementById('rally-organization');
    const electionBus = document.getElementById('election-bus');
    const mediaInteraction = document.getElementById('media-interaction');
    const cityCardsContainer = document.getElementById('city-cards');
    const policyCardsContainer = document.getElementById('policy-cards');
    const messageLog = document.getElementById('message-log');
    const gameStatus = document.getElementById('game-status');
    const updateUrlBtn = document.getElementById('update-url-btn');
    
    // Sayfa yüklendiğinde
    document.addEventListener('DOMContentLoaded', () => {
      // LocalStorage'dan son kullanılan URL'yi al
      const savedUrl = localStorage.getItem('serverUrl');
      if (savedUrl) {
        serverUrlInput.value = savedUrl;
      }
      
      // URL güncelleme butonu için event listener
      updateUrlBtn.addEventListener('click', () => {
        // URL'yi kaydet
        localStorage.setItem('serverUrl', serverUrlInput.value);
        
        // URL formatını kontrol et ve düzelt
        let url = serverUrlInput.value.trim();
        
        // URL'yi WebSocket formatına dönüştür
        if (url.startsWith('http://')) {
          url = 'ws://' + url.substring(7);
          serverUrlInput.value = url;
        } else if (url.startsWith('https://')) {
          url = 'wss://' + url.substring(8);
          serverUrlInput.value = url;
        }
        
        // Sondaki slash'i kontrol et
        if (!url.endsWith('/')) {
          url += '/';
          serverUrlInput.value = url;
        }
        
        localStorage.setItem('serverUrl', url);
        alert('URL güncellendi: ' + url);
      });
      
      // Bağlantı olayları
      connectBtn.addEventListener('click', connect);
      disconnectBtn.addEventListener('click', disconnect);
      
      // Oyun olayları
      createGameBtn.addEventListener('click', createGame);
      joinGameBtn.addEventListener('click', joinGame);
      startGameBtn.addEventListener('click', startGame);
      selectCityBtn.addEventListener('click', selectCity);
      organizeRallyBtn.addEventListener('click', organizeRally);
      playerReadyBtn.addEventListener('click', setPlayerReady);
      document.getElementById('send-message-btn').addEventListener('click', sendChatMessage);
      document.getElementById('media-action-btn').addEventListener('click', performMediaAction);
    });
    
    // WebSocket bağlantısını kur
    function connect() {
      // URL'yi kaydet
      localStorage.setItem('serverUrl', serverUrlInput.value);
      
      const playerName = playerNameInput.value.trim();
      if (!playerName) {
        alert('Lütfen bir oyuncu ismi girin.');
        return;
      }
      
      try {
        const serverUrl = serverUrlInput.value.trim();
        
        // URL formatını kontrol et
        if (!serverUrl.startsWith('ws://') && !serverUrl.startsWith('wss://')) {
          // HTTP/HTTPS URL'yi WebSocket URL'sine dönüştür
          if (serverUrl.startsWith('http://')) {
            serverUrlInput.value = 'ws://' + serverUrl.substring(7);
          } else if (serverUrl.startsWith('https://')) {
            serverUrlInput.value = 'wss://' + serverUrl.substring(8);
          } else {
            alert('Geçersiz URL formatı. ws://, wss://, http:// veya https:// ile başlamalıdır.');
            return;
          }
        }
        
        ws = new WebSocket(serverUrlInput.value);
        
        ws.onopen = () => {
          logMessage(`Sunucuya bağlandı: ${serverUrlInput.value}`, 'info');
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          gamePanel.style.display = 'block';
          
          // Bağlantı sonrası oyuncu kaydı
          sendToServer({
            type: 'register',
            playerName: playerName
          });
        };
        
        ws.onmessage = (event) => {
          handleServerMessage(event.data);
        };
        
        ws.onerror = (error) => {
          logMessage(`WebSocket hatası: ${error.message}`, "error");
        };
        
        ws.onclose = () => {
          logMessage("Sunucu bağlantısı kapatıldı", "received");
          resetUI();
        };
      } catch (error) {
        logMessage(`Bağlantı hatası: ${error.message}`, "error");
      }
    }
    
    // WebSocket bağlantısını kapat
    function disconnect() {
      if (ws) {
        ws.close();
      }
    }
    
    // UI'ı sıfırla
    function resetUI() {
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      startGameBtn.disabled = true;
      gamePanel.style.display = 'none';
      actionPanel.style.display = 'none';
      citySelection.style.display = 'none';
      rallyOrganization.style.display = 'none';
      electionBus.style.display = 'none';
      mediaInteraction.style.display = 'none';
      
      playerReadyBtn.style.display = 'none';
      
      gameStatus.textContent = "Bağlantı bekleniyor...";
      
      cityCardsContainer.innerHTML = '';
      policyCardsContainer.innerHTML = '';
      
      currentGameId = null;
      isGameOwner = false;
      gameState = {
        turn: 0,
        phase: null,
        cards: {},
        selectedCards: []
      };
    }
    
    // Sunucudan gelen mesajları işle
    function handleServerMessage(data) {
      try {
        const message = JSON.parse(data);
        logMessage(`Alındı: ${JSON.stringify(message, null, 2)}`, "received");
        
        switch (message.type) {
          case 'connection':
            connectionId = message.connectionId;
            break;
            
          case 'register':
            playerId = message.playerId;
            playerName = playerNameInput.value.trim();
            logMessage(`Kayıt başarılı, Oyuncu ID: ${playerId}`);
            break;
            
          case 'gameCreated':
            currentGameId = message.gameId;
            isGameOwner = true;
            gameIdInput.value = currentGameId;
            
            logMessage(`Oyun oluşturuldu, ID: ${currentGameId}`);
            gameStatus.textContent = `Oyun oluşturuldu, oyuncuların katılması bekleniyor...`;
            
            startGameBtn.disabled = false;
            break;
            
          case 'joinedGame':
            currentGameId = message.gameId;
            logMessage(`Oyuna katıldınız, ID: ${currentGameId}`);
            gameStatus.textContent = `Oyuna katıldınız, oyun başlaması bekleniyor...`;
            
            actionPanel.style.display = 'block';
            break;
            
          case 'playerJoined':
            updatePlayersInfo(message.players);
            break;
            
          case 'gameStarted':
            logMessage('Oyun başladı!');
            gameStatus.textContent = `Oyun başladı! Tur: ${message.gameState.turn}`;
            break;
            
          case 'turnStarted':
            gameState.turn = message.turn;
            gameState.phase = 'cardDistribution';
            gameState.cards = message.cards;
            
            logMessage(`Tur ${message.turn} başladı`);
            gameStatus.textContent = `Tur ${message.turn} - Kart dağıtımı aşaması`;
            
            actionPanel.style.display = 'block';
            citySelection.style.display = 'block';
            
            // Şehir kartlarını göster
            displayCityCards(message.cards.city || []);
            break;
            
          case 'citySelected':
            logMessage(`Şehir seçildi: ${message.city.name}`);
            citySelection.style.display = 'none';
            
            // Hazır butonunu göster
            playerReadyBtn.style.display = 'block';
            playerReadyBtn.dataset.phase = 'citySelection';
            break;
            
          case 'phaseChange':
            gameState.phase = message.phase;
            logMessage(`Faz değişti: ${message.phase}`);
            gameStatus.textContent = `Tur ${gameState.turn} - ${message.phase} aşaması`;
            
            // Faza göre UI'ı güncelle
            updateUIForPhase(message.phase);
            break;
            
          case 'rallyResult':
            logMessage(`Miting sonucu: ${message.message}`);
            rallyOrganization.style.display = 'none';
            
            // Hazır butonunu göster
            playerReadyBtn.style.display = 'block';
            playerReadyBtn.dataset.phase = 'rallyOrganization';
            break;
            
          case 'busChatMessage':
            displayChatMessage(message);
            break;
            
          case 'mediaActionResult':
            logMessage(`Medya aksiyonu sonucu: ${message.message}`);
            mediaInteraction.style.display = 'none';
            
            // Hazır butonunu göster
            playerReadyBtn.style.display = 'block';
            playerReadyBtn.dataset.phase = 'mediaInteraction';
            break;
            
          case 'pollResults':
            logMessage(`Anket sonuçları:`, null);
            for (const playerId in message.results) {
              logMessage(`  ${message.results[playerId].playerName}: %${message.results[playerId].votesPercentage.toFixed(2)}`);
            }
            
            // Hazır butonunu göster
            playerReadyBtn.style.display = 'block';
            playerReadyBtn.dataset.phase = 'polling';
            break;
            
          case 'gameEnd':
            logMessage(`Oyun sona erdi! Kazanan: ${message.winner.name}`);
            gameStatus.textContent = `Oyun sona erdi! Kazanan: ${message.winner.name}`;
            
            actionPanel.style.display = 'none';
            break;
            
          case 'error':
            logMessage(`Hata: ${message.message}`, "error");
            break;
        }
      } catch (error) {
        logMessage(`Mesaj işleme hatası: ${error.message}`, "error");
      }
    }
    
    // Yeni oyun oluştur
    function createGame() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        logMessage("Sunucuya bağlı değil", "error");
        return;
      }
      
      const message = {
        type: 'createGame',
        data: {
          gameSettings: {
            minPlayers: 2,
            maxPlayers: 10,
            totalTurns: 10
          }
        }
      };
      
      sendToServer(message);
    }
    
    // Mevcut oyuna katıl
    function joinGame() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        logMessage("Sunucuya bağlı değil", "error");
        return;
      }
      
      const gameId = gameIdInput.value;
      
      if (!gameId) {
        logMessage("Oyun ID'si gereklidir", "error");
        return;
      }
      
      const message = {
        type: 'joinGame',
        gameId: gameId
      };
      
      sendToServer(message);
    }
    
    // Oyunu başlat
    function startGame() {
      if (!currentGameId || !isGameOwner) {
        logMessage("Oyun sahibi değilsiniz", "error");
        return;
      }
      
      const message = {
        type: 'startGame',
        gameId: currentGameId
      };
      
      sendToServer(message);
    }
    
    // Şehir seç
    function selectCity() {
      if (!gameState.selectedCards.length || gameState.selectedCards.length > 1) {
        logMessage("Bir şehir seçmelisiniz", "error");
        return;
      }
      
      const cityCardId = gameState.selectedCards[0];
      
      const message = {
        type: 'selectCity',
        gameId: currentGameId,
        playerId: playerId,
        data: {
          cityCardId: cityCardId
        }
      };
      
      sendToServer(message);
    }
    
    // Miting düzenle
    function organizeRally() {
      if (!gameState.selectedCards.length) {
        logMessage("En az bir politika kartı seçmelisiniz", "error");
        return;
      }
      
      const message = {
        type: 'organizeRally',
        gameId: currentGameId,
        playerId: playerId,
        data: {
          policyCardIds: gameState.selectedCards
        }
      };
      
      sendToServer(message);
    }
    
    // Oyuncu hazır
    function setPlayerReady() {
      const phase = playerReadyBtn.dataset.phase;
      
      const message = {
        type: 'playerReady',
        gameId: currentGameId,
        playerId: playerId,
        data: {
          phase: phase
        }
      };
      
      sendToServer(message);
      playerReadyBtn.style.display = 'none';
    }
    
    // Sohbet mesajı gönder
    function sendChatMessage() {
      const messageText = document.getElementById('chat-message').value;
      
      if (!messageText) {
        return;
      }
      
      const message = {
        type: 'busChatMessage',
        gameId: currentGameId,
        playerId: playerId,
        data: {
          message: messageText
        }
      };
      
      sendToServer(message);
      document.getElementById('chat-message').value = '';
    }
    
    // Medya aksiyonu gerçekleştir
    function performMediaAction() {
      const actionType = document.getElementById('media-action-type').value;
      const content = document.getElementById('media-content').value;
      const budget = parseInt(document.getElementById('media-budget').value, 10);
      
      if (!content) {
        logMessage("İçerik gereklidir", "error");
        return;
      }
      
      if (isNaN(budget) || budget <= 0) {
        logMessage("Geçerli bir bütçe girilmelidir", "error");
        return;
      }
      
      const message = {
        type: 'mediaAction',
        gameId: currentGameId,
        playerId: playerId,
        data: {
          actionType: actionType,
          content: content,
          budget: budget,
          targetId: null // Şimdilik hedef belirtmiyoruz
        }
      };
      
      sendToServer(message);
      document.getElementById('media-content').value = '';
    }
    
    // Sunucuya mesaj gönder
    function sendToServer(message) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        logMessage("Sunucuya bağlı değil", "error");
        return;
      }
      
      const messageStr = JSON.stringify(message);
      ws.send(messageStr);
      
      logMessage(`Gönderildi: ${messageStr}`, "sent");
    }
    
    // Mesaj geçmişine mesaj ekle
    function logMessage(message, type) {
      const logItem = document.createElement('div');
      logItem.className = `log-item ${type || ''}`;
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      
      messageLog.appendChild(logItem);
      messageLog.scrollTop = messageLog.scrollHeight;
    }
    
    // Şehir kartlarını görüntüle
    function displayCityCards(cards) {
      cityCardsContainer.innerHTML = '';
      gameState.selectedCards = [];
      
      cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'card';
        cardElement.dataset.id = card.id;
        cardElement.innerHTML = `
          <h4>${card.name}</h4>
          <p>${card.description}</p>
        `;
        
        cardElement.addEventListener('click', () => {
          // Diğer kartların seçimini kaldır
          document.querySelectorAll('#city-cards .card').forEach(el => {
            el.classList.remove('selected');
          });
          
          // Bu kartı seç
          cardElement.classList.add('selected');
          
          gameState.selectedCards = [card.id];
          selectCityBtn.disabled = false;
        });
        
        cityCardsContainer.appendChild(cardElement);
      });
    }
    
    // Politika kartlarını görüntüle
    function displayPolicyCards(cards) {
      policyCardsContainer.innerHTML = '';
      gameState.selectedCards = [];
      
      cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'card';
        cardElement.dataset.id = card.id;
        cardElement.innerHTML = `
          <h4>${card.title}</h4>
          <p>${card.description}</p>
        `;
        
        cardElement.addEventListener('click', () => {
          // Kartın seçim durumunu değiştir
          cardElement.classList.toggle('selected');
          
          // Seçili kartları güncelle
          if (cardElement.classList.contains('selected')) {
            gameState.selectedCards.push(card.id);
          } else {
            const index = gameState.selectedCards.indexOf(card.id);
            if (index !== -1) {
              gameState.selectedCards.splice(index, 1);
            }
          }
          
          organizeRallyBtn.disabled = gameState.selectedCards.length === 0;
        });
        
        policyCardsContainer.appendChild(cardElement);
      });
    }
    
    // Sohbet mesajını görüntüle
    function displayChatMessage(message) {
      const chatLogItem = document.createElement('div');
      chatLogItem.className = 'log-item';
      chatLogItem.textContent = `[${new Date(message.timestamp).toLocaleTimeString()}] ${message.playerName}: ${message.message}`;
      
      messageLog.appendChild(chatLogItem);
      messageLog.scrollTop = messageLog.scrollHeight;
    }
    
    // Oyuncu bilgilerini güncelle
    function updatePlayersInfo(players) {
      let playersInfo = `Oyuncular: `;
      
      players.forEach((player, index) => {
        if (index > 0) playersInfo += ', ';
        playersInfo += player.name;
      });
      
      gameStatus.textContent = playersInfo;
    }
    
    // Aşamaya göre UI'ı güncelle
    function updateUIForPhase(phase) {
      // Tüm aksiyon panellerini gizle
      citySelection.style.display = 'none';
      rallyOrganization.style.display = 'none';
      electionBus.style.display = 'none';
      mediaInteraction.style.display = 'none';
      playerReadyBtn.style.display = 'none';
      
      // Geçerli aşamaya göre paneli göster
      switch (phase) {
        case 'citySelection':
          citySelection.style.display = 'block';
          displayCityCards(gameState.cards.city || []);
          break;
          
        case 'rallyOrganization':
          rallyOrganization.style.display = 'block';
          displayPolicyCards(gameState.cards.policy || []);
          break;
          
        case 'electionBus':
          electionBus.style.display = 'block';
          break;
          
        case 'mediaInteraction':
          mediaInteraction.style.display = 'block';
          break;
          
        case 'polling':
          // Anket sonuçları için özel bir panel yok, sadece hazır butonunu göster
          playerReadyBtn.style.display = 'block';
          playerReadyBtn.dataset.phase = 'polling';
          break;
      }
    }
  </script>
</body>
</html>